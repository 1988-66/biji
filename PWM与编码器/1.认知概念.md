你在 STM32F407 标准库中配置 PWM、编码器模式时，困惑于 PSC 和 ARR 参数的填写，核心问题是 F407 与 F103 主频差异导致参数不同，同时需要针对四驱小车的 PWM 驱动、编码器测速场景找到通用且可落地的配置方法。下面我将从核心逻辑、分场景配置、差异应对三个方面给出完整解决方案：

### 一、核心前提：先明确定时器时钟来源（F407 与 F103 的关键差异）

PSC 和 ARR 的计算都依赖**定时器的输入时钟（CK_PSC）**，这是 F407 与 F103 参数不同的根本原因，先理清这个基础：

1. **STM32F103**：最高主频 72MHz，APB1 总线时钟最大 36MHz（挂载 TIM2~TIM7、TIM12~TIM14），APB2 总线时钟最大 72MHz（挂载 TIM1、TIM8、TIM9~TIM11）；**当 APB 总线预分频系数为 1 时，定时器时钟 = APB 总线时钟；否则定时器时钟 = APB 总线时钟 ×2**。
2. **STM32F407**：最高主频 168MHz，APB1 总线时钟最大 42MHz（挂载 TIM2~TIM7、TIM12~TIM14），APB2 总线时钟最大 84MHz（挂载 TIM1、TIM8、TIM9~TIM11）；**时钟倍频规则与 F103 完全一致**。
3. 关键结论：配置前先确定你使用的定时器挂载在 APB1 还是 APB2，以及对应总线的预分频系数（由系统时钟配置函数`SystemInit()`或自定义时钟配置决定），最终算出定时器输入时钟`CK_PSC`（后续所有计算都基于此）。

### 二、场景 1：PWM 驱动电机（核心需求：目标 PWM 频率 + 占空比分辨率）

四驱小车驱动直流电机时，PWM 的核心是**确定目标频率**（一般 20kHz 左右，无电磁噪音且驱动板稳定）和**足够的占空比分辨率**（调节电机转速更细腻），PSC 和 ARR 的计算围绕这两个需求展开。

#### 1. 核心计算公式

定时器计数器时钟（CK_CNT）= 定时器输入时钟（CK_PSC） / (PSC + 1)

PWM 输出频率（f_PWM）= 计数器时钟（CK_CNT） / (ARR + 1)

合并可得：

plaintext

```
f_PWM = CK_PSC / [(PSC + 1) × (ARR + 1)]
```

其中：

- PSC：预分频器值，16 位无符号整数，取值范围 0~65535
- ARR：自动重装载值，16 位无符号整数，取值范围 0~65535
- 占空比分辨率 = 1 / (ARR + 1)（ARR 越大，分辨率越高，占空比调节越细腻，例如 ARR=999 时，分辨率为 0.1%）

#### 2. 配置步骤（以 F407 为例，落地性极强）

步骤 1：确定基础参数

- 假设使用 TIM1（挂载 APB2），F407 系统时钟配置为 168MHz，APB2 预分频系数 = 1（默认配置），因此`CK_PSC=84MHz`（APB2 时钟 = 84MHz，预分频 = 1，无倍频）
- 目标 PWM 频率：20kHz（直流电机最优选择之一）

步骤 2：优先确定 ARR（保证占空比分辨率）

为了兼顾分辨率和避免 PSC 超出范围，优先选择 ARR 为 10 的整数倍或接近 1000、2000 等数值，例如选择`ARR=999`（分辨率 0.1%，足够电机平稳调速）

步骤 3：代入公式计算 PSC

plaintext

```
20000 = 84000000 / [(PSC + 1) × (999 + 1)]
(PSC + 1) = 84000000 / (20000 × 1000) = 4.2
```

由于 PSC 必须为整数，调整 ARR 或 PSC：

- 方案 1：调整 ARR 为`ARR=399`（分辨率 0.25%，仍满足需求）
    
    重新计算：`(PSC + 1) = 84000000 / (20000 × 400) = 10.5`（仍非整数）
- 方案 2：调整目标频率为 21kHz（不影响电机驱动），保持 ARR=999
    
    计算：`(PSC + 1) = 84000000 / (21000 × 1000) = 4` → `PSC=3`
- 最终有效参数：`PSC=3`，`ARR=999`，PWM 频率 = 21kHz，分辨率 0.1%

步骤 4：验证合理性

确保 PSC 和 ARR 都在 0~65535 范围内（此例中完全满足），若超出范围（例如目标频率过低），可增大 ARR（优先）或增大 PSC。

#### 3. 关键说明

- 若你需要和 F103 相同的 PWM 频率，只需替换 F103 的定时器输入时钟（例如 F103 TIM1 的 CK_PSC=72MHz），沿用相同计算公式即可得到对应的 PSC 和 ARR。
- 四驱小车的 4 路 PWM 建议使用同一个定时器的不同通道（或同总线的定时器），保证 PWM 频率一致，电机转速同步性更好。

### 三、场景 2：编码器模式（采集电机转速，核心需求：计数精度 + 无溢出）

四驱小车中编码器（多为增量式正交编码器）用于测速，此时定时器工作在**正交编码器模式**，PSC 和 ARR 的作用与 PWM 模式完全不同，配置逻辑也截然不同。

#### 1. 核心特性（与 PWM 模式的关键区别）

- 编码器模式下，定时器的计数器**不由内部时钟驱动**，而是由编码器的 A、B 相脉冲信号驱动（正交编码，4 倍频计数），因此**PSC 的核心作用是脉冲分频，一般建议设为 0（不分频，保留最高计数精度）**。
- ARR 的作用不再是计算频率，而是**计数器溢出阈值**（16 位定时器计数器范围 0~ARR），核心要求是：**在一个系统采样周期内，计数器的计数值增量不会超过 ARR，避免溢出丢失计数信息**。

#### 2. 配置步骤（以 F407 为例，针对四驱小车测速）

步骤 1：明确 PSC 配置

直接设置`PSC=0`，不进行脉冲分频，确保编码器的每一个脉冲都被计数，最大化测速精度（这是编码器模式的标准配置，几乎无需修改）。

步骤 2：确定 ARR 的取值（核心难点）

ARR 的取值需结合 3 个参数计算：

- 编码器线数 N（例如 1000 线，增量式正交编码器每转产生 4×N 个脉冲，即 4000 个计数）
- 电机减速比 K（例如减速箱 1:30，电机每转 30 圈，编码器转 1 圈）
- 系统采样周期 T（例如 10ms，即 0.01s，系统每隔 10ms 读取一次计数器值计算转速）

计算公式（最大允许计数值）：

plaintext

```
// 电机最大转速下，单个采样周期内的最大计数增量
ΔCNT_max = (电机最大转速r/min × 4×N × K) / 60 / T
```

ARR 的取值需满足：`ARR ≥ ΔCNT_max`，且`ARR ≤ 65535`（16 位定时器上限）。

示例：

- 编码器线数 N=1000，减速比 K=30，电机最大转速 300r/min，采样周期 T=0.01s
- 计算：`ΔCNT_max = (300 × 4×1000 × 30) / 60 / 0.01 = 6000000`（明显超过 65535）
- 调整方案：增大采样周期（如 T=100ms），或采用 32 位定时器（F407 无 32 位定时器，可通过软件记录溢出次数补偿），最终取`ARR=65535`（16 位上限，通过软件溢出补偿解决超范围问题）

步骤 3：标准配置落地

最终编码器模式参数：`PSC=0`，`ARR=65535`（最大化计数范围，减少溢出概率），后续通过软件读取计数器值（`TIM_GetCounter(TIMx)`），结合采样周期计算转速即可。

#### 3. 关键说明

- 编码器模式下，无需关注定时器内部时钟（CK_PSC），因为计数器由外部脉冲驱动，这是与 PWM 模式的本质区别。
- 若出现计数器溢出，可通过定时器溢出中断（`TIM_IT_Update`）记录溢出次数，在测速时进行补偿，避免转速计算误差。

### 四、总结（核心要点提炼）

1. 主频差异的核心影响：仅改变定时器输入时钟（CK_PSC），PSC/ARR 的**计算逻辑和配置步骤在 F407 与 F103 上完全一致**，只需替换 CK_PSC 即可。
2. PWM 模式：围绕 “目标频率 + 分辨率”，用公式`f_PWM=CK_PSC/[(PSC+1)×(ARR+1)]`计算，优先保证 ARR 以获取足够分辨率。
3. 编码器模式：固定`PSC=0`，ARR 取 65535（最大化计数范围），重点通过软件避免 / 补偿计数器溢出。
	4. 四驱小车落地建议：PWM 频率选 20~25kHz，编码器采样周期选 10~100ms，参数确定后通过示波器（验证 PWM）、串口（打印编码器计数值）调试验证。